name: Build and Release on Version Change

on:
  push:
    branches:
      - main
      - master
    paths:
      - '.env.production'

jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.version_changed }}
      new_version: ${{ steps.check.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if VITE_VERSION changed
        id: check
        run: |
          # Get the current VITE_VERSION
          CURRENT_VERSION=$(grep '^VITE_VERSION=' .env.production | cut -d '=' -f2 | tr -d '"' | tr -d ' ')
          echo "Current version: $CURRENT_VERSION"
          
          # Check if previous commit exists
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "No previous commit found (initial commit)"
            PREVIOUS_VERSION=""
          else
            # Get the previous VITE_VERSION from the previous commit
            if git checkout HEAD~1 -- .env.production 2>&1; then
              PREVIOUS_VERSION=$(grep '^VITE_VERSION=' .env.production | cut -d '=' -f2 | tr -d '"' | tr -d ' ')
            else
              echo "File did not exist in previous commit"
              PREVIOUS_VERSION=""
            fi
            echo "Previous version: $PREVIOUS_VERSION"
            
            # Restore current version
            git checkout HEAD -- .env.production
          fi
          
          # Check if version changed
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] && [ -n "$CURRENT_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Version changed from '$PREVIOUS_VERSION' to '$CURRENT_VERSION'"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged or empty"
          fi

  build-and-release:
    needs: check-version-change
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: Build frontend
        run: npm run frontend:prod
      
      - name: Build application with PyInstaller
        run: pyinstaller build-windows.spec
      
      - name: Verify build output
        run: |
          echo "Checking dist folder contents:"
          dir dist
          if (Test-Path "dist\GO Dash") {
            echo "GO Dash folder found"
            dir "dist\GO Dash"
          } else {
            echo "Error: GO Dash folder not found"
            exit 1
          }
        shell: pwsh
      
      - name: Create zip archive
        run: |
          Compress-Archive -Path "dist\GO Dash\*" -DestinationPath "GO-Dash-${{ needs.check-version-change.outputs.new_version }}.zip"
        shell: pwsh
      
      - name: Check if release exists
        id: check_release
        run: |
          $tag = "${{ needs.check-version-change.outputs.new_version }}"
          $releases = gh release list --limit 100
          if ($releases -match $tag) {
            echo "release_exists=true" >> $env:GITHUB_OUTPUT
            echo "Release $tag already exists"
          } else {
            echo "release_exists=false" >> $env:GITHUB_OUTPUT
            echo "Release $tag does not exist"
          }
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        if: steps.check_release.outputs.release_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version-change.outputs.new_version }}
          name: Release ${{ needs.check-version-change.outputs.new_version }}
          body: |
            Automatic release for version ${{ needs.check-version-change.outputs.new_version }}
            
            Built from commit ${{ github.sha }}
          files: |
            GO-Dash-${{ needs.check-version-change.outputs.new_version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
